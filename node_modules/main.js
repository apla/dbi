var fs = require ('fs');
var dataflows = require ('dataflo.ws');

var DBInfo = require ('db-info');

var data = fs.readFileSync ('./.dbi.json');
var connections = JSON.parse (data.toString());

function listConnections (cb) {

	var connectionsList = {};

	for (var c in connections) {
		connectionsList[c] = {
			user: connections[c].user || connections[c].userName,
			database: connections[c].database || connections[c].connectString || connections[c].filename,
			host: connections[c].host || connections[c].server,
			driver: connections[c].driver
		};
	}

	cb (null, connectionsList);
}

function getDBInfo (connectionName, cb) {

	console.log (connectionName);

	var db;

	dbInfo = new DBInfo (connections[connectionName]);
	dbInfo.connect (function (err, connection) {

		if (err) {
			cb (err);
		}

		db = connection;

		// dbInfo.do ([], function (err, done) {});
		dbInfo.getInfo (function (err, schema) {
			cb (err, schema);
		});
	});
}

function runQuery (connectionName, query, cb) {

	console.log (connectionName);

	var db;

	dbInfo = new DBInfo (connections[connectionName]);
	dbInfo.connect (function (err, connection) {

		if (err) {
			cb (err);
		}

		dbInfo.do ([query], function (err, results) {
			cb (err, results[0]);
		});
	});
}


module.exports.listConnections = listConnections;

module.exports.getDBInfo = getDBInfo;

module.exports.runQuery = runQuery;
